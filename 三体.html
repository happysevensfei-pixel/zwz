<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三体问题 - 3D交互演示</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: #000;
            overflow: hidden;
            color: #fff;
        }

        #canvas-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        .watermark {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.3);
            pointer-events: none;
            z-index: 1000;
        }

        .control-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 30px;
            min-width: 400px;
            cursor: move;
            z-index: 100;
        }

        .panel-header {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
            color: #fff;
        }

        .step-panel {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            width: 300px;
            cursor: move;
            z-index: 100;
        }

        .step-item {
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }

        .step-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .step-item.active {
            background: rgba(100, 200, 255, 0.3);
            border-left: 3px solid #64c8ff;
        }

        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            max-width: 300px;
            font-size: 14px;
            line-height: 1.6;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        button {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .parameter-control {
            margin: 15px 0;
        }

        .parameter-control label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .parameter-control input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }

        .parameter-value {
            text-align: right;
            font-size: 12px;
            color: #aaa;
        }

        #typewriter {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 20px;
            max-width: 600px;
            font-size: 16px;
            line-height: 1.6;
            min-height: 60px;
        }
    </style>
</head>

<body>
    <div id="canvas-container">
        <div class="watermark">造物主 4.0 plus</div>

        <div class="control-panel" id="controlPanel">
            <div class="panel-header">三体问题控制面板</div>

            <div class="parameter-control">
                <label>引力常数 G</label>
                <input type="range" id="gravitySlider" min="0.1" max="2" step="0.1" value="1">
                <div class="parameter-value" id="gravityValue">1.0</div>
            </div>

            <div class="parameter-control">
                <label>质量比例</label>
                <input type="range" id="massSlider" min="0.5" max="2" step="0.1" value="1">
                <div class="parameter-value" id="massValue">1.0</div>
            </div>

            <div class="parameter-control">
                <label>初始速度</label>
                <input type="range" id="velocitySlider" min="0.1" max="2" step="0.1" value="1">
                <div class="parameter-value" id="velocityValue">1.0</div>
            </div>

            <div class="button-group">
                <button onclick="togglePause()">暂停/继续</button>
                <button onclick="resetSimulation()">重置</button>
                <button onclick="toggleFullscreen()">全屏</button>
            </div>
        </div>

        <div class="step-panel" id="stepPanel">
            <div class="panel-header">学习步骤</div>
            <div class="step-item active" onclick="showStep(1)">第一步：认识三体系统</div>
            <div class="step-item" onclick="showStep(2)">第二步：设置初始条件</div>
            <div class="step-item" onclick="showStep(3)">第三步：观察引力作用</div>
            <div class="step-item" onclick="showStep(4)">第四步：理解混沌现象</div>
            <div class="step-item" onclick="showStep(5)">第五步：探索稳定轨道</div>
        </div>

        <div class="info-panel">
            <h3>三体问题简介</h3>
            <p>三体问题是经典力学中研究三个天体在相互引力作用下的运动规律的问题。由于引力相互作用的复杂性，三体系统通常表现出混沌特性。</p>
        </div>

        <div id="typewriter"></div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/cannon.js/0.6.2/cannon.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>

    <script>
        let scene, camera, renderer, controls;
        let bodies = [];
        let meshes = [];
        let trails = [];
        let isPaused = false;
        let clock = new THREE.Clock();

        // 三体系统参数
        let G = 1.0;
        let massScale = 1.0;
        let velocityScale = 1.0;

        // 初始化场景
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000011);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 20, 30);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // 添加光源
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(10, 20, 10);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            // 添加星空背景
            createStarField();

            // 初始化三体系统
            initThreeBodySystem();

            // 设置拖动功能
            setupDraggablePanels();

            // 设置参数控制
            setupParameterControls();

            animate();
        }

        function createStarField() {
            const starsGeometry = new THREE.BufferGeometry();
            const starsMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 0.1 });

            const starsVertices = [];
            for (let i = 0; i < 10000; i++) {
                const x = (Math.random() - 0.5) * 2000;
                const y = (Math.random() - 0.5) * 2000;
                const z = (Math.random() - 0.5) * 2000;
                starsVertices.push(x, y, z);
            }

            starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starsVertices, 3));
            const stars = new THREE.Points(starsGeometry, starsMaterial);
            scene.add(stars);
        }

        function initThreeBodySystem() {
            // 清除之前的物体
            bodies.forEach(body => scene.remove(body));
            meshes.forEach(mesh => scene.remove(mesh));
            trails.forEach(trail => scene.remove(trail));
            bodies = [];
            meshes = [];
            trails = [];

            // 创建三个天体
            const positions = [
                new THREE.Vector3(5, 0, 0),
                new THREE.Vector3(-2.5, 4.33, 0),
                new THREE.Vector3(-2.5, -4.33, 0)
            ];

            const velocities = [
                new THREE.Vector3(0, 0.5, 0),
                new THREE.Vector3(-0.433, -0.25, 0),
                new THREE.Vector3(0.433, -0.25, 0)
            ];

            const masses = [1.0, 1.0, 1.0];
            const colors = [0xff4444, 0x44ff44, 0x4444ff];
            const sizes = [1.5, 1.5, 1.5];

            for (let i = 0; i < 3; i++) {
                // 创建天体
                const geometry = new THREE.SphereGeometry(sizes[i] * massScale, 32, 32);
                const material = new THREE.MeshPhongMaterial({
                    color: colors[i],
                    emissive: colors[i],
                    emissiveIntensity: 0.2
                });
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.copy(positions[i]);
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                scene.add(mesh);
                meshes.push(mesh);

                // 创建轨迹
                const trailGeometry = new THREE.BufferGeometry();
                const trailMaterial = new THREE.LineBasicMaterial({
                    color: colors[i],
                    opacity: 0.5,
                    transparent: true
                });
                const trail = new THREE.Line(trailGeometry, trailMaterial);
                scene.add(trail);
                trails.push({
                    line: trail,
                    positions: [positions[i].clone()]
                });

                // 存储天体数据
                bodies.push({
                    position: positions[i].clone(),
                    velocity: velocities[i].clone().multiplyScalar(velocityScale),
                    mass: masses[i] * massScale,
                    color: colors[i]
                });
            }
        }

        function updatePhysics(dt) {
            if (isPaused) return;

            const dt2 = dt * dt;

            // 计算引力
            for (let i = 0; i < bodies.length; i++) {
                let force = new THREE.Vector3(0, 0, 0);

                for (let j = 0; j < bodies.length; j++) {
                    if (i !== j) {
                        const diff = new THREE.Vector3().subVectors(bodies[j].position, bodies[i].position);
                        const distance = diff.length();
                        const forceMagnitude = G * bodies[i].mass * bodies[j].mass / (distance * distance);
                        force.add(diff.normalize().multiplyScalar(forceMagnitude));
                    }
                }

                // 更新速度和位置
                const acceleration = force.divideScalar(bodies[i].mass);
                bodies[i].velocity.add(acceleration.multiplyScalar(dt));
                bodies[i].position.add(bodies[i].velocity.clone().multiplyScalar(dt));

                // 更新网格位置
                meshes[i].position.copy(bodies[i].position);

                // 更新轨迹
                trails[i].positions.push(bodies[i].position.clone());
                if (trails[i].positions.length > 1000) {
                    trails[i].positions.shift();
                }

                const positions = new Float32Array(trails[i].positions.length * 3);
                trails[i].positions.forEach((pos, idx) => {
                    positions[idx * 3] = pos.x;
                    positions[idx * 3 + 1] = pos.y;
                    positions[idx * 3 + 2] = pos.z;
                });
                trails[i].line.geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            }
        }

        function animate() {
            requestAnimationFrame(animate);

            const deltaTime = Math.min(clock.getDelta(), 0.1);
            updatePhysics(deltaTime);

            controls.update();
            renderer.render(scene, camera);
        }

        function setupDraggablePanels() {
            setupDraggable('controlPanel');
            setupDraggable('stepPanel');
        }

        function setupDraggable(elementId) {
            const element = document.getElementById(elementId);
            let isDragging = false;
            let startX, startY, initialX, initialY;

            element.addEventListener('mousedown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;

                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialX = element.offsetLeft;
                initialY = element.offsetTop;
                element.style.cursor = 'grabbing';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                const dx = e.clientX - startX;
                const dy = e.clientY - startY;

                element.style.left = initialX + dx + 'px';
                element.style.top = initialY + dy + 'px';
                element.style.transform = 'none';
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                element.style.cursor = 'move';
            });
        }

        function setupParameterControls() {
            const gravitySlider = document.getElementById('gravitySlider');
            const massSlider = document.getElementById('massSlider');
            const velocitySlider = document.getElementById('velocitySlider');

            gravitySlider.addEventListener('input', (e) => {
                G = parseFloat(e.target.value);
                document.getElementById('gravityValue').textContent = G.toFixed(1);
            });

            massSlider.addEventListener('input', (e) => {
                massScale = parseFloat(e.target.value);
                document.getElementById('massValue').textContent = massScale.toFixed(1);
                resetSimulation();
            });

            velocitySlider.addEventListener('input', (e) => {
                velocityScale = parseFloat(e.target.value);
                document.getElementById('velocityValue').textContent = velocityScale.toFixed(1);
                resetSimulation();
            });
        }

        function togglePause() {
            isPaused = !isPaused;
        }

        function resetSimulation() {
            initThreeBodySystem();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function showStep(step) {
            const steps = document.querySelectorAll('.step-item');
            steps.forEach(s => s.classList.remove('active'));
            steps[step - 1].classList.add('active');

            const messages = [
                "第一步：认识三体系统。三体问题研究三个天体在相互引力作用下的运动规律。在理想条件下，我们忽略其他外力，只考虑引力相互作用。",
                "第二步：设置初始条件。我们设置了三个质量相等的天体，初始位置呈等边三角形分布，每个天体都有特定的初始速度，使得系统能够开始运动。",
                "第三步：观察引力作用。每个天体都受到其他两个天体的引力作用，引力大小与质量乘积成正比，与距离平方成反比。这是牛顿万有引力定律的直接应用。",
                "第四步：理解混沌现象。由于三体系统的非线性特性，微小的初始条件差异会导致完全不同的运动轨迹，这就是混沌现象。系统对初始条件极其敏感。",
                "第五步：探索稳定轨道。虽然三体系统通常表现出混沌行为，但在特定条件下也存在周期性轨道，如拉格朗日点附近的稳定轨道。调整参数可以观察不同的运动模式。"
            ];

            typeWriter(messages[step - 1]);
        }

        function typeWriter(text) {
            const element = document.getElementById('typewriter');
            element.textContent = '';
            let i = 0;

            function type() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    setTimeout(type, 30);
                }
            }
            type();
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // 初始化
        init();
        showStep(1);
    </script>
</body>

</html>